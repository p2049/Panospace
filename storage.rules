rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      // STRICT: Ensure both user is signed in AND matches the path UID
      return signedIn() && request.auth.uid == uid;
    }

    // --- SECURITY RULES BY CATEGORY ---
    
    // Collections
    match /collections/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Studios
    match /studios/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Museums
    match /museums/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Magazines
    match /magazines/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // General Posts
    match /posts/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Posts Display (High-res images)
    match /posts_display/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Post Thumbnails
    match /posts_thumbnails/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Profiles
    match /profile_photos/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Banners
    match /banners/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Shop Items
    match /shopItems/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }

    // Legacy Support (Scoped as tightly as possible)
    match /collectionCovers/{uid}/{allPaths=**} {
      allow read: if true;
      allow write: if isOwner(uid);
    }
  }
}
